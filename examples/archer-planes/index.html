<!DOCTYPE html>
<html>
<head>
    <title>little-planes</title>

    <style>

        body {
            margin: 0;
        }

        #container {

            position: absolute;

            width: 800px;
            height: 400px;
            top: 100px;
            left: 100px;
            background-color: #aaaaff;
        }

        #error {
            display: none;
        }

        .ac-connector.default.plane .line {
            background-color: green;
            border-color: green;
        }

        .ac-welding-seam.default.plane {
            background-color: green;
        }

        .callout-header {
            padding: 4px 8px;
            background-color: lightgreen;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .callout-body {
            padding: 4px 8px;
            background-color: gold;
        }

        .ac-anchor.default.plane .outer-circle {
            border-color: green;
        }

        .ac-anchor.default.plane .inner-circle {
            background-color: green;
        }

    </style>
    <link rel="stylesheet" type="text/css" href="../../dist/archer.callouts.css">
</head>
<body>

<select id="select-plane">

</select>
<button onclick="toggleCallout()">callout</button>

<div id="container"></div>

<div id="error">
    <h1>The graphic files could not be loaded</h1>
    <p>Please note that this example may only work when served through a web server. The example code needs to
        dynamically load files which for security reasons is not allowed when serving from the file system.</p>
</div>

<!-- Include the runtime library -->
<!-- NOTE: The Archer Runtime library is free for personal, non-commercial use and testing environments. -->
<!-- For using the Archer Runtime library in production environments please visit https://archer.graphics to learn more about commercial licensing options. -->
<script src='libs/archer.min.js'></script>
<script src='../../dist/archer.callouts.min.js'></script>

<script language='javascript' type='text/javascript'>

    /*
     * NOTE: This example may only work when it is loaded through a web server. The example code needs to load the archer
     * graphic file as well as the archer configuration file, which for security reasons is not allowed when loading the
     * HTML file from the file system.
     */

    /**
     * Root location where your interactive graphic is stored.
     * Leave empty to resolve paths relative from this HTML.
     * Can also contain an absolute URL to the server where your graphic is stored, for example:
     * http://my-domain.com/graphics/my-graphic/
     */
    var rootUrl = '';

    /**
     * Location of the assets folder, by default resolved relative from root URL
     */
    var assetUrl = rootUrl + 'assets';

    /**
     * Location of the SVG file, by default resolved relative from root URL
     */
    var graphicUrl = rootUrl + 'archer.graphic.svg';

    /**
     * Location of the graphic configuration file, by default resolved relative from root URL
     */
    var configUrl = rootUrl + 'archer.config.json';

    /**
     * The container HTML element in which to display the graphic
     */
    var container = document.getElementById('container');

    // Create a graphic instance over the container
    var graphic = archer.create(container);

    // Tell the graphic where assets (e.g. images) are located
    graphic.document.setAssetRoot(assetUrl);

    // Load graphic and configuration
    graphic.loadUrl(graphicUrl, configUrl);

    var calloutManager = new ArcherCallouts.CalloutManager();


    var lastRun = Date.now();


    // Wait until files are loaded
    graphic.on('ready', function () {

        // Make graphic fit into container bounds
        graphic.view.zoomToFit();

        // Enable zoom / pan with mouse
        graphic.view.enableMouse(true, true);


        /*
         callout = calloutManager.create(container);
         callout.bind(element);
         callout.show();

         var headerSection = callout.sections[0];
         headerSection.content = '<div class="callout-header">Plane 1</div>';

         var bodySection = callout.sections[1];
         bodySection.content = '<div class="callout-body">This is my little plane</div>';

         callout.offSiteHtml = '<div>Somewhere here is a <i>plane</i></div>';

         */

        var loop = function () {

            var timeDelta = (Date.now() - lastRun) / 1000;

            for (var i = 0; i < planes.length; i++) {
                var plane = planes[i];
                plane.animate(timeDelta);
            }


            /*
             setTimeout(function () {
             console.log('bbox:');
             console.log(element.getBBox());
             callout.updatePosition();
             }, 1000);
             */


            lastRun = Date.now();
            requestAnimationFrame(loop);
        };

        requestAnimationFrame(loop);
        // Add event listeners

    });

    // Files could not be loaded, maybe due to security restrictions
    // Display error message
    graphic.on('error', function () {
        document.getElementById('error').style['display'] = 'block';
    });

    var UP = 38;
    var RIGHT = 39;
    var DOWN = 40;
    var LEFT = 37;
    var SPACE = 32;

    window.onload = function (e) {

        document.addEventListener('keydown', function (evt) {

            evt.preventDefault();
            evt.stopImmediatePropagation();

            switch (evt.keyCode) {
                case UP: {
                    planes[planeSelector.selectedIndex].accelerate();
                    break;
                }
                case RIGHT: { //Right
                    planes[planeSelector.selectedIndex].rotateRight();
                    break;
                }
                case DOWN: { //Down
                    planes[planeSelector.selectedIndex].break();
                    break;
                }
                case LEFT: { //Left
                    planes[planeSelector.selectedIndex].rotateLeft();
                    break;
                }
                case SPACE: {
                    planes[planeSelector.selectedIndex].pause();
                    break;
                }
            }
        });

        document.addEventListener('keyup', function (evt) {

            planes[planeSelector.selectedIndex].move();
        });
    };

    var ROTATION_SPEED = 180; // 360Â° / s
    var ACCELERATION = 0.8 // 0.1px / s^2

    var MOVE = 0;
    var ROTATE_LEFT = 1;
    var ROTATE_RIGHT = 2;
    var ACCELERATE = 3;
    var BREAK = 4;
    var PAUSED = 5;


    var Plane = function (key) {

        this._key = key;
        this._moveSpeed = 0.1 + Math.random() * 0.4; // 1px / s
        this._degree = Math.random() * 360;
        this._state = MOVE;
        this._xPos = Math.random() * 100;
        this._yPos = Math.random() * 50;

        this._callout = null;
    };

    Plane.prototype = {
        get key() {
            return this._key;
        }
    };

    Plane.prototype.pause = function () {

        this._state = this._state == PAUSED ? MOVE : PAUSED;
    };

    Plane.prototype.move = function () {
        this._state = this._state != PAUSED ? MOVE : PAUSED;
    };

    Plane.prototype.accelerate = function () {
        this._state = ACCELERATE;
    };

    Plane.prototype.break = function () {
        this._state = BREAK;
    };

    Plane.prototype.rotateLeft = function () {
        this._state = ROTATE_LEFT;
    };

    Plane.prototype.rotateRight = function () {
        this._state = ROTATE_RIGHT;
    };

    Plane.prototype.animate = function (timeDelta) {

        var moveSpeedIncrement = ACCELERATION * timeDelta;
        var rotateSpeedIncrement = ROTATION_SPEED * timeDelta;

        if (this._state == ACCELERATE) this._moveSpeed += moveSpeedIncrement;
        if (this._state == BREAK) this._moveSpeed -= moveSpeedIncrement;
        if (this._state == ROTATE_LEFT) {
            this._degree -= rotateSpeedIncrement;
            if (this._degree < 0) this._degree = 360 - rotateSpeedIncrement;
        }
        if (this._state == ROTATE_RIGHT) {
            this._degree += rotateSpeedIncrement;
            if (this._degree > 360) this._degree = rotateSpeedIncrement;
        }

        var rad = (this._degree / 360) * (2 * Math.PI);
        var dy = Math.sin(rad) * (this._state == PAUSED ? 0 : this._moveSpeed);
        var dx = Math.cos(rad) * (this._state == PAUSED ? 0 : this._moveSpeed);
        this._xPos += dx;
        this._yPos += dy;

        if (this._xPos > 100) this._xPos = 0;
        if (this._xPos < 0) this._xPos = 100;
        if (this._yPos > 50) this._yPos = 0;
        if (this._yPos < 0) this._yPos = 50;

        graphic.setValue(this._key + '-x', this._xPos);
        graphic.setValue(this._key + '-y', this._yPos);
        graphic.setValue(this._key + '-angle', this._degree);

        if( this._callout)  this._callout.updatePosition();

    };

    Plane.prototype.toggleCallout = function () {

        if (this._callout == null) {

            this._callout = calloutManager.create(container, {customClass: 'plane'});
            this._callout.bind(graphic.element(this._key));

            var headerSection = this._callout.sections[0];
            headerSection.content = '<div class="callout-header">' + this._key + '</div>';

            var bodySection = this._callout.sections[1];
            bodySection.content = '<div class="callout-body">asfsd</div>';

            this._callout.offSiteHtml = '<div>There is plane ' + this._key + '</div>';
        }

        if (this._callout.visible) {
            this._callout.hide();
        } else {
            this._callout.show();
            this._callout.updatePosition();
        }
    };

    var planes = [
        new Plane('plane-1'),
        new Plane('plane-2'),
        new Plane('plane-3')
    ];

    var planeSelector = document.getElementById('select-plane');
    for (var i = 0; i < planes.length; i++) {

        var option = document.createElement('option');
        option.innerHTML = planes[i].key;
        planeSelector.appendChild(option);
    }

    var toggleCallout = function () {
        planes[planeSelector.selectedIndex].toggleCallout();
    }


</script>

</body>
</html>